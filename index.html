
<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Draai het wiel voor KiKa üíõ</title>

<style>
:root {
  --bg:#ffe0ef;
  --text:#222;
  --btn:#3f3f3f;
  --btn-text:#fff;
  --brand:#ffb703;

  /* Door JS gezet voor pointer/wrap schalen */
  --ptrSide: 12px;
  --ptrHeight: 18px;
  --wrapTopPad: 24px;

  /* Modal vars */
  --sheetRadius: 18px;
  --sheetMaxW: 560px;
  --safeB: env(safe-area-inset-bottom, 0px);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden;
}

body.lock-scroll{
  height:100dvh; /* voorkomt ‚Äòrubberband‚Äô op iOS */
  overflow:hidden;
}

main{
  max-width:560px;
  margin:24px auto;
  padding:16px;
  text-align:center;
}

h1{margin:0 0 8px;font-size:clamp(22px, 3.5vw, 28px)}
p{margin:0 0 16px;font-size:clamp(15px, 2.8vw, 16px)}

/* Actieknoppen */
.actions{display:grid;gap:10px;margin:16px 0}
button,
a.btn{
  display:inline-block;
  text-align:center;
  border:0;border-radius:999px;
  padding:12px 18px;
  background:var(--btn);
  color:var(--btn-text);
  font-weight:700;
  cursor:pointer;
  text-decoration:none;
  font-size:clamp(15px, 3vw, 16px);
}

.note{
  background:#fff6f8;
  border-radius:10px;
  padding:10px 12px;
  margin-bottom:20px;
  font-size:14px;
  text-align:left;
}

/* Responsive wiel-container */
.wheel-wrap{
  position:relative;
  width:min(92vw, 560px);
  margin:0 auto 28px;
  padding-top:var(--wrapTopPad);
  display:grid;
  place-items:center;
}

/* Pointer ‚Äì schaalt mee via CSS vars */
.pointer{
  position:absolute;
  top:0;left:50%;
  transform:translate(-50%,-6px);
  width:0;height:0;
  border-left: var(--ptrSide) solid transparent;
  border-right: var(--ptrSide) solid transparent;
  border-bottom: var(--ptrHeight) solid var(--brand);
  z-index:2;
  filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
}

@keyframes tick-bounce {
  0%   { transform:translate(-50%,-6px) rotate(0deg); }
  30%  { transform:translate(-50%,-8px) rotate(-8deg); }
  60%  { transform:translate(-50%,-5px) rotate(4deg); }
  100% { transform:translate(-50%,-6px) rotate(0deg); }
}
.pointer.ticking{ animation:tick-bounce 120ms ease-out; }
@media (prefers-reduced-motion: reduce){ .pointer.ticking{ animation:none !important; } }

/* Canvas is responsief: 1:1 */
canvas#wheel{
  width:100%;
  height:auto;
  aspect-ratio:1 / 1;
  background:#fff;
  border-radius:50%;
}

/* ========= Bottom‚Äësheet modal ========= */
.modal{
  position:fixed; inset:0;
  display:none;
  z-index:1001;
  pointer-events:none;
}
.modal.open{display:block; pointer-events:auto}

.modal__backdrop{
  position:absolute; inset:0;
  background:rgba(0,0,0,.4);
  backdrop-filter:saturate(100%) blur(2px);
}

.modal__sheet{
  position:absolute;
  left:50%; transform:translateX(-50%);
  bottom:0;
  width:min(100vw, var(--sheetMaxW));
  max-height:calc(100dvh - 12px);
  background:white;
  border-top-left-radius:var(--sheetRadius);
  border-top-right-radius:var(--sheetRadius);
  box-shadow:0 -10px 30px rgba(0,0,0,.25);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* Sheet header (sticky) */
.sheet__header{
  position:sticky; top:0; z-index:1;
  background:white;
  padding:14px 16px 10px;
  border-bottom:1px solid #f0f0f0;
}
.sheet__handle{
  width:44px; height:5px; border-radius:999px;
  background:#e5e5e5; margin:6px auto 10px;
}
.sheet__title{
  margin:0;
  font-size:20px;
  font-weight:800;
  text-align:center;
}

/* Sheet body (scrollbaar) */
.sheet__body{
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:12px 16px 16px;
}

/* Sheet footer (sticky acties) */
.sheet__footer{
  position:sticky; bottom:0; z-index:1;
  background:white;
  border-top:1px solid #f0f0f0;
  padding:10px 12px calc(10px + var(--safeB));
  display:grid; gap:8px;
}

.modal__btn{
  background:var(--brand);
  border:0;
  padding:12px 16px;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.modal__btn--secondary{
  background:#fff; color:#222; border:2px solid var(--brand);
}

/* Categorie */
.modal__cat{
  margin:6px 0 8px;
  font-weight:800;
  color:var(--brand);
  text-align:center;
}
#modalPrize{ margin:0 0 12px; text-align:center; }

/* Deelblok */
.share{ margin-top:8px; text-align:center; }
.share__fallback{ display:none; margin-top:8px; }
.share__fallback.show{ display:block; }
.share__row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin:8px 0; }
.share__link{
  padding:6px 10px; border-radius:999px; background:#f2f2f2; color:#222; text-decoration:none;
  font-weight:600; border:1px solid #e6e6e6;
}
.share__copy{
  border:0; border-radius:8px; padding:6px 10px; background:#efefef; font-weight:600; cursor:pointer;
}
.share__ok{ font-size:12px; color:#3a7; margin-top:6px; min-height:1em; }

/* Selfie-blok als accordion */
.selfie{
  margin-top:12px;
  border-radius:12px;
  background:#fff6f0;
  border:1px solid #ffe0b3;
}
.selfie summary{
  list-style:none;
  padding:12px 14px;
  font-weight:800;
  cursor:pointer;
}
.selfie summary::-webkit-details-marker{ display:none; }
.selfie__hint{ font-size:13px; color:#666; margin:6px 0 10px; text-align:center; padding:0 10px; }
.selfie__wrap{ display:grid; gap:8px; justify-items:center; padding:0 10px 12px; }

/* Stacking video + canvas voor live preview
   FIX: container krijgt ECHT hoogte (anders 0 op mobiel) */
.selfie__stack{
  position:relative;
  width:min(88vw, 420px);
  aspect-ratio:1 / 1;          /* => hoogte aanwezig */
  min-height:280px;            /* fallback voor oude browsers */
}
.selfie__stack .selfie__video,
.selfie__stack .selfie__canvas{
  position:absolute; inset:0;
  width:100%; height:100%;    /* vulling van de container */
  object-fit:cover;            /* center-crop */
  border-radius:12px;
}
.selfie__stack .selfie__canvas{ z-index:1; }

.selfie__row{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:6px; }
.selfie__btn{ background:#111; color:#fff; border:0; border-radius:999px; padding:8px 14px; font-weight:700; cursor:pointer; }
.selfie__btn--ghost{ background:#fff; color:#111; border:2px solid #111; }

/* Confetti canvas (pagina) */
#confetti{
  position:fixed; inset:0; pointer-events:none; display:none; z-index:1000;
}
#confetti.show{display:block}

/* Visueel verborgen voor SR */
.sr-only{
  position:absolute !important;
  width:1px; height:1px;
  padding:0; margin:-1px;
  overflow:hidden; clip:rect(0, 0, 1px, 1px);
  white-space:nowrap; border:0;
}
</style>
</head>

<body>
<main>

<h1>Draai het wiel voor KiKa üíõ</h1>
<p>
Hallo ik ben Steven, <br>
Met dit wiel doe ik mee aan een 24‚Äëuurs skeeleractie voor KiKa (Stichting Kinderen Kankervrij). Het wiel staat voor inzet, doorzettingsvermogen en vooral hoop. Hoop op betere behandelingen en een toekomst waarin kinderen niet meer hoeven te vechten tegen kanker.
Tijdens deze 24 uur ga ik tot het uiterste om zoveel mogelijk geld op te halen voor onderzoek naar kinderkanker. Door mee te doen of te sponsoren draag je hier direct aan bij.
Elke bijdrage ‚Äì groot of klein ‚Äì maakt verschil. Doneer, draai mee, steun KiKa en help mij het verschil te maken. Dank je wel! üíôüõº
</p>

<div class="actions">
  https://24kika.nl/doneren/?deelnemer=steven-arbonDoneer nu</a>
  <button type="button" onclick="spinWheel()">Ik heb gedoneerd ‚Üí Draai!</button>
</div>

<div class="note">Prijzen hebben geen geldwaarde</div>

<div class="wheel-wrap">
  <div id="pointer" class="pointer"></div>
  <canvas id="wheel" width="300" height="300"></canvas>
</div>

</main>

<canvas id="confetti"></canvas>

<!-- Bottom-sheet modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
  <div class="modal__backdrop" onclick="closeModal()"></div>

  <section class="modal__sheet" role="document">
    <header class="sheet__header" id="sheetHeader" tabindex="-1">
      <div class="sheet__handle" aria-hidden="true"></div>
      <h2 id="modalTitle" class="sheet__title">Gefeliciteerd üéâ</h2>
    </header>

    <div class="sheet__body">
      <p id="modalCategory" class="modal__cat"></p>
      <p id="modalPrize"></p>

      <!-- DEEL-blok -->
      <div class="share">
        <button id="shareBtn" class="modal__btn modal__btn--secondary" onclick="sharePrize()">
          üì§ KiKa-wiel delen
        </button>
        <div id="shareFallback" class="share__fallback" aria-live="polite">
          <div class="share__row">
            <a id="shareWhatsApp" class="share__link" target="_blank" rel="noopener">WhatsApp</a>
            <a id="shareX"        class="share__link" target="_blank" rel="noopener">X</a>
            <a id="shareFB"       class="share__link" target="_blank" rel="noopener">Facebook</a>
            <a id="shareLI"       class="share__link" target="_blank" rel="noopener">LinkedIn</a>
          </div>
          <button id="copyShare" class="share__copy" type="button">üìã Kopieer tekst</button>
          <div id="copyFeedback" class="share__ok" aria-live="polite"></div>
        </div>
      </div>

      <!-- üì∏ SELFIE (accordion) -->
      <details id="selfieBlock" class="selfie" hidden>
        <summary>üì∏ Confetti‚Äëselfie</summary>
        <p class="selfie__hint">Maak een selfie met confetti en deel ‚Äôm met de tekst:<br>
          <strong>‚ÄúIk ben een topper, ik heb gedoneerd en steun KiKa!‚Äù</strong></p>
        <div class="selfie__wrap">
          <div class="selfie__stack">
            <video id="selfieVideo" class="selfie__video" playsinline muted></video>
            <canvas id="selfieCanvas" class="selfie__canvas" width="1080" height="1080" aria-label="Selfie‚Äëvoorbeeld"></canvas>
          </div>
          <div class="selfie__row">
            <button id="btnStartCam" class="selfie__btn" type="button">üé• Start camera</button>
            <button id="btnShot" class="selfie__btn" type="button" disabled>üì∏ Neem selfie</button>
            <button id="btnRetake" class="selfie__btn selfie__btn--ghost" type="button" hidden>‚Ü∫ Opnieuw</button>
            <button id="btnDownload" class="selfie__btn" type="button" hidden>‚¨áÔ∏è Download (PNG)</button>
          </div>
          <div id="selfieErr" class="selfie__hint" role="status" aria-live="polite"></div>
        </div>
      </details>
    </div>

    <footer class="sheet__footer">
      <button id="badgeBtn" class="modal__btn modal__btn--secondary" onclick="downloadBadgePNG()">
        üì∏ Download badge (PNG)
      </button>
      <button class="modal__btn" onclick="closeModal()">Nog een keer draaien</button>
    </footer>
  </section>
</div>

<!-- SR live region -->
<div id="ariaResult" class="sr-only" aria-live="assertive"></div>

<script>
/* ========= CATEGORIE√ãN ========= */
const moppen = [
  "Waarom won de skeeler een prijs? Omdat hij altijd blijft rollen üí™",
  "Ik zou hier een mop plaatsen‚Ä¶ maar jij bent de echte winnaar üòÑ",
  "Gefeliciteerd! Je hebt +1 goed‚Äëgevoel gewonnen ‚ú®",
  "Mijn benen doen 24 uur mee. Jij deed vandaag iets n√≥g belangrijkers üíõ",
  "Dit wiel draait op goede daden ‚Äî dankjewel! üôå"
];
const feitjes = [
  "Wist je dat lachen stress vermindert? üòä",
  "Elke donatie helpt KiKa bij beter onderzoek üíõ",
  "Bewegen maakt je hersenen aantoonbaar vrolijker üß†‚ú®",
  "Samen kleine acties doen maakt een groot verschil üåç"
];
const quotes = [
  "Kleine moeite, groot verschil üíõ",
  "Samen maken we kanker kansloos.",
  "Wie goed doet, ontmoet geluk ‚ú®",
  "Vandaag heb jij iets goeds gedaan üåà"
];
const challenges = [
  "Geef vandaag iemand een compliment üòä",
  "Drink een extra glas water üíß‚Äî je verdient het!",
  "Stuur dit wiel door naar 1 vriend(in) üîÑ",
  "Maak een selfie op een gekke plek, post ‚Äôm op social en vraag ook te doneren voor dit wiel"
];
const verrassingen = [
  "üéâ Confetti‚Äëbonus! Jij bent officieel een Topper!"
];
function randomItem(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

/* ========= Wiel ========= */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const pointerEl = document.getElementById('pointer');

let size = 300, c = size/2, r = 140;
function scalePointerWithWheel(){
  const ptrH = Math.round(size * 0.06);
  const ptrSide = Math.max(10, Math.round(ptrH * 0.66));
  document.documentElement.style.setProperty('--ptrHeight', ptrH + 'px');
  document.documentElement.style.setProperty('--ptrSide', ptrSide + 'px');
  const wrapTopPad = ptrH + 10;
  document.documentElement.style.setProperty('--wrapTopPad', wrapTopPad + 'px');
}
function resizeWheelCanvas(){
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const cssSize = Math.round(canvas.getBoundingClientRect().width);
  const finalCssSize = Math.max(160, cssSize || 300);
  canvas.width  = Math.floor(finalCssSize * dpr);
  canvas.height = Math.floor(finalCssSize * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  size = finalCssSize; c = size/2; r = Math.round(size * 0.47);
  scalePointerWithWheel();
  drawWheel();
}
window.addEventListener('resize', resizeWheelCanvas);
window.addEventListener('orientationchange', resizeWheelCanvas);

const categoryLabels = ['üòÇ Mop', 'üß† Feit', 'üí¨ Quote', 'üéØ Challenge', 'üéâ Verrassing'];
const categoryData   = [ moppen, feitjes, quotes, challenges, verrassingen ];
const colors = ["#ffbe0b","#fb5607","#8338ec","#3a86ff","#06d6a0"];
const slice = Math.PI*2/categoryLabels.length;
let rotation = 0, spinning = false, selectedIndex = -1;

function getWheelLabelFontSize(){ const px = Math.round(size * 0.045); return Math.max(14, Math.min(px, 22)); }
function drawCategoryLabel(text, radius){
  ctx.textAlign = "right"; ctx.fillStyle = "#111";
  ctx.font = `bold ${getWheelLabelFontSize()}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
  ctx.fillText(text, radius - Math.max(10, Math.round(size*0.04)), Math.round(size*0.008));
}
function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save(); ctx.translate(c,c); ctx.rotate(rotation);
  for(let i=0;i<categoryLabels.length;i++){
    const isSelected = (selectedIndex === i);
    const dimOthers  = (selectedIndex !== -1 && !isSelected);
    ctx.save(); if (dimOthers) ctx.globalAlpha = 0.4;
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,i*slice,(i+1)*slice);
    ctx.fillStyle = colors[i]; ctx.fill();
    if (isSelected){ ctx.lineWidth = Math.max(3, Math.round(size*0.012)); ctx.strokeStyle="#fff";
      ctx.shadowColor="rgba(255,255,255,.9)"; ctx.shadowBlur=Math.round(size*0.06); ctx.stroke(); ctx.shadowBlur=0; }
    ctx.rotate(i*slice + slice/2); drawCategoryLabel(categoryLabels[i], r);
    ctx.restore();
  }
  ctx.restore();
}

/* ========= Confetti (pagina) ========= */
const confettiCanvas = document.getElementById('confetti');
const cfx = confettiCanvas.getContext('2d');
let particles = [], confettiRAF=null, confettiLoop=false, burstTimer=null;
const HARD_LIMIT = 6000;
function resizeConfetti(){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  confettiCanvas.width  = Math.floor(innerWidth * dpr);
  confettiCanvas.height = Math.floor(innerHeight * dpr);
  confettiCanvas.style.width = innerWidth + 'px';
  confettiCanvas.style.height= innerHeight + 'px';
  cfx.setTransform(dpr,0,0,dpr,0,0);
}
function wheelCenter(){ const r = canvas.getBoundingClientRect(); return { x:r.left + r.width/2, y:r.top + r.height/2 }; }
function addBurst({ count=120, g=0.15, spread=9, sizeMul=1, palette } = {}){
  const MAX_PARTICLES = 8000; if (particles.length > MAX_PARTICLES) return;
  const o = wheelCenter(); const colors=["#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff","#06d6a0"];
  for (let i=0;i<count;i++){ const a=Math.random()*Math.PI*2, s=3+Math.random()*spread;
    const w=(6+Math.random()*8)*sizeMul, h=(8+Math.random()*12)*sizeMul;
    particles.push({ x:o.x,y:o.y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, g, r:Math.random()*Math.PI, vr:(Math.random()-.5)*.35, w,h, c:colors[Math.floor(Math.random()*colors.length)], life:0, maxLife:4000+Math.random()*2500 });
  }
}
function stepAndDraw(dt){
  cfx.clearRect(0,0,innerWidth,innerHeight);
  const airFriction = Math.pow(0.992, dt/16);
  if (particles.length > HARD_LIMIT) particles.splice(0, particles.length - HARD_LIMIT);
  particles = particles.filter(p => {
    p.x += p.vx*(dt/16); p.y += p.vy*(dt/16); p.vy += p.g*(dt/16); p.vx *= airFriction; p.r += p.vr*(dt/16); p.life += dt;
    cfx.save(); cfx.translate(p.x,p.y); cfx.rotate(p.r); cfx.fillStyle=p.c; cfx.fillRect(-p.w/2,-p.h/2,p.w,p.h); cfx.restore();
    return p.life < p.maxLife && p.y < innerHeight + 80;
  });
}
function tickConfetti(t){
  if (!tickConfetti.prev) tickConfetti.prev = t;
  const dt = Math.min(50, t - tickConfetti.prev); tickConfetti.prev = t;
  stepAndDraw(dt);
  if (confettiLoop || particles.length){ confettiRAF = requestAnimationFrame(tickConfetti); }
  else { confettiRAF = null; confettiCanvas.classList.remove('show'); }
}
function ensureAnimating(){
  resizeConfetti(); confettiCanvas.classList.add('show');
  if (!confettiRAF){ tickConfetti.prev = 0; confettiRAF = requestAnimationFrame(tickConfetti); }
}
const REDUCED_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
function launchStandardConfetti(){ if (REDUCED_MOTION) return; ensureAnimating(); addBurst({count:120}); setTimeout(()=>addBurst({count:90}),300); }
function startMegaConfetti(){ if (REDUCED_MOTION || confettiLoop) return; confettiLoop=true; ensureAnimating();
  addBurst({count:300,g:0.16,spread:10,sizeMul:1.15}); setTimeout(()=>addBurst({count:240,g:0.16,spread:10,sizeMul:1.10}),220); setTimeout(()=>addBurst({count:200,g:0.17,spread:11,sizeMul:1.10}),480);
  burstTimer=setInterval(()=>{ addBurst({count:200,g:0.17,spread:11,sizeMul:1.10}); setTimeout(()=>addBurst({count:140,g:0.18,spread:8,sizeMul:1.00}),180); if(Math.random()<0.33){ setTimeout(()=>addBurst({count:120,g:0.19,spread:9,sizeMul:1.05}),420); } },800);
}
function stopMegaConfetti(){ confettiLoop=false; if (burstTimer){ clearInterval(burstTimer); burstTimer=null; } }
window.addEventListener('resize', ()=>{ if (confettiRAF || confettiLoop) resizeConfetti(); });

/* ========= Audio ========= */
let audioCtx; let lastTickIndex=null;
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if(audioCtx.state === 'suspended'){ audioCtx.resume(); } }
function playGameShowJingle({ volume = 0.65 } = {}) {
  ensureAudio(); const t0=audioCtx.currentTime; const master=audioCtx.createGain(); master.gain.setValueAtTime(Math.max(0,Math.min(1,volume)),t0); master.connect(audioCtx.destination);
  function bell({ freq, start, dur=0.5, peak=0.35, pan=0 }){ const s=audioCtx.createOscillator(), t=audioCtx.createOscillator(); s.type='sine'; t.type='triangle'; s.frequency.setValueAtTime(freq,start); t.frequency.setValueAtTime(freq*2,start); const g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,start); g.gain.linearRampToValueAtTime(peak,start+0.02); g.gain.exponentialRampToValueAtTime(0.0001,start+dur); const p=audioCtx.createStereoPanner(); p.pan.setValueAtTime(pan,start); s.connect(g); t.connect(g); g.connect(p).connect(master); s.start(start); t.start(start); s.stop(start+dur+0.05); t.stop(start+dur+0.05); }
  function handClap({ start, gain=0.24 }){ const bursts=[0,0.012,0.028]; bursts.forEach((off,i)=>{ const len=Math.floor(audioCtx.sampleRate*0.06); const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate); const data=buf.getChannelData(0); for(let n=0;n<len;n++){ const w=(Math.random()*2-1); data[n]=w*Math.pow(1-n/len,2.2); } const src=audioCtx.createBufferSource(); src.buffer=buf; const g=audioCtx.createGain(); const decay=0.06+i*0.02; g.gain.setValueAtTime(gain*(1-i*0.2),start+off); g.gain.exponentialRampToValueAtTime(0.0001,start+off+decay); src.connect(g).connect(master); src.start(start+off); src.stop(start+off+decay+0.02); }); }
  function tambourine({ start, dur=0.25, gain=0.08, pan=0.1 }){ const len=Math.floor(audioCtx.sampleRate*dur); const buf=audioCtx.createBuffer(1,len,audioCtx.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<len;i++){ const t=i/len; const n=(Math.random()*2-1); data[i]=n*(0.8+0.2*Math.random())*Math.pow(1-t,2.0); } const src=audioCtx.createBufferSource(); src.buffer=buf; const g=audioCtx.createGain(); g.gain.setValueAtTime(gain,start); g.gain.exponentialRampToValueAtTime(0.0001,start+dur); const p=audioCtx.createStereoPanner(); p.pan.setValueAtTime(pan,start); src.connect(g).connect(p).connect(master); src.start(start); src.stop(start+dur+0.05); }
  if (!REDUCED_MOTION && navigator.vibrate) navigator.vibrate([10,20,10]);
  handClap({start:t0+0.00,gain:0.24}); tambourine({start:t0+0.00,dur:0.22,gain:0.08,pan:0.12}); bell({freq:784.00,start:t0+0.02,dur:0.45,peak:0.32,pan:-0.05});
  const chordStart=t0+0.18;
  bell({freq:523.25,start:chordStart+0.00,dur:0.42,peak:0.28,pan:-0.12});
  bell({freq:659.25,start:chordStart+0.01,dur:0.42,peak:0.26,pan:0.00});
  bell({freq:783.99,start:chordStart+0.02,dur:0.42,peak:0.24,pan:0.12});
  bell({freq:349.23*2,start:chordStart+0.20,dur:0.38,peak:0.26,pan:-0.1});
  bell({freq:440.00*2,start:chordStart+0.21,dur:0.38,peak:0.24,pan:0.0});
  bell({freq:261.63*2,start:chordStart+0.22,dur:0.38,peak:0.24,pan:0.1});
  bell({freq:392.00*2,start:chordStart+0.38,dur:0.38,peak:0.26,pan:-0.1});
  bell({freq:493.88*2,start:chordStart+0.39,dur:0.38,peak:0.24,pan:0.0});
  bell({freq:293.66*2,start:chordStart+0.40,dur:0.38,peak:0.22,pan:0.1});
  const end=t0+0.76;
  handClap({start:end+0.02,gain:0.20}); tambourine({start:end+0.00,dur:0.22,gain:0.1,pan:-0.1});
  bell({freq:523.25,start:end+0.00,dur:0.5,peak:0.34,pan:-0.08});
  bell({freq:659.25,start:end+0.01,dur:0.5,peak:0.32,pan:0.00});
  bell({freq:783.99,start:end+0.02,dur:0.5,peak:0.30,pan:0.08});
}
function playTick(){
  ensureAudio(); if (!REDUCED_MOTION && navigator.vibrate) navigator.vibrate(8);
  const t0=audioCtx.currentTime; const osc=audioCtx.createOscillator(); const gain=audioCtx.createGain();
  osc.type='square'; osc.frequency.setValueAtTime(1200,t0);
  gain.gain.setValueAtTime(0.001,t0); gain.gain.linearRampToValueAtTime(0.12,t0+0.008); gain.gain.exponentialRampToValueAtTime(0.0001,t0+0.06);
  osc.connect(gain).connect(audioCtx.destination); osc.start(t0); osc.stop(t0+0.07);
  if (pointerEl){ pointerEl.classList.remove('ticking'); void pointerEl.offsetWidth; pointerEl.classList.add('ticking'); }
}

/* ========= Spin ========= */
let detentOffset=0; const DETENT_BASE=0.025, DETENT_DECAY=0.88, DETENT_SNAP_FORWARD=0.6, DETENT_CLAMP=0.15;
document.addEventListener('keydown', (e) => {
  const open = document.getElementById('modal').classList.contains('open');
  if (!open && (e.key === ' ' || e.key === 'Enter')) { e.preventDefault(); spinWheel(); }
});
(function setupFocusTrap(){
  const modal = document.getElementById('modal'); const sheet = modal?.querySelector('.modal__sheet');
  modal?.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') return;
    const f = sheet.querySelectorAll('button,a,[tabindex]:not([tabindex="-1"])');
    if (!f.length) return;
    const first = f[0], last = f[f.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  });
})();

function spinWheel(){
  if(spinning) return; spinning = true; lastTickIndex = null; detentOffset = 0; selectedIndex = -1; drawWheel();
  ensureAudio();
  const start = rotation; const target = start + Math.random()*Math.PI*6 + Math.PI*4; const t0=performance.now(), DURATION=2600;
  (function anim(t){
    const p=Math.min((t-t0)/DURATION,1); const baseRot=start+(target-start)*(1-Math.pow(1-p,3));
    detentOffset *= DETENT_DECAY; if (detentOffset > DETENT_CLAMP) detentOffset = DETENT_CLAMP; if (detentOffset < -DETENT_CLAMP) detentOffset = -DETENT_CLAMP;
    rotation = baseRot + detentOffset; drawWheel();
    const twoPi=Math.PI*2; const a=(Math.PI*1.5 - (rotation % twoPi) + twoPi) % twoPi; const idx=Math.floor(a / slice) % categoryLabels.length;
    if (lastTickIndex === null || idx !== lastTickIndex){
      playTick(); const speedFactor=(1-p)*(1-p); const impulse=DETENT_BASE*(0.35+0.65*speedFactor);
      detentOffset -= impulse; setTimeout(()=>{ detentOffset += impulse*DETENT_SNAP_FORWARD; }, 60); lastTickIndex = idx;
    }
    if (p < 1){ requestAnimationFrame(anim); } else {
      spinning=false;
      const finalA=(Math.PI*1.5 - (rotation % twoPi) + twoPi) % twoPi; const rawIdx=Math.floor(finalA / slice);
      const finalIdx=((rawIdx % categoryLabels.length) + categoryLabels.length) % categoryLabels.length;
      selectedIndex = finalIdx; drawWheel();
      const prizeArr = categoryData[finalIdx]; const prize = randomItem(prizeArr);
      openModal(prize || 'üéÅ Verrassing: je bent een topper! üôå', categoryLabels[finalIdx]);
    }
  })(t0);
}

/* ========= Badge helpers ========= */
function drawBadgeToCanvas(prize, category, opts={}) {
  const size = opts.size || 1080;
  const pad  = Math.round(size * 0.06);
  const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#ffb703';
  const cvs = document.createElement('canvas'); cvs.width = cvs.height = size; const ctx = cvs.getContext('2d');
  const grad = ctx.createRadialGradient(size*0.5, size*0.4, size*0.1, size*0.5, size*0.6, size*0.8);
  grad.addColorStop(0,'#fff8fb'); grad.addColorStop(1,'#ffe0ef'); ctx.fillStyle=grad; ctx.fillRect(0,0,size,size);
  ctx.save(); ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); const r=size/2 - pad/2; ctx.arc(size/2,size/2,r,0,Math.PI*2); ctx.fill(); ctx.restore();
  drawConfettiScatter(ctx,size,90);
  const topY = pad + 20; drawRibbon(ctx,size/2,topY,Math.round(size*0.66),60,brand);
  ctx.fillStyle='#111'; ctx.font=`700 ${Math.round(size*0.06)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('KiKa wiel ‚Äì winnaar!', size/2, topY);
  const pillY = topY + Math.round(size*0.12); drawPill(ctx,size/2,pillY,Math.round(size*0.34),Math.round(size*0.07),brand);
  ctx.fillStyle='#111'; ctx.font=`700 ${Math.round(size*0.05)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`; ctx.fillText(category||'Categorie', size/2, pillY);
  const bodyMaxW=size - pad*2; const bodyY=pillY + Math.round(size*0.10); ctx.fillStyle='#222'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.font=`600 ${Math.round(size*0.065)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
  const lines=wrapText(ctx, prize||'Gefeliciteerd!', bodyMaxW, Math.round(size*0.09), 4); drawLines(ctx, lines, size/2, bodyY, Math.round(size*0.09));
  const ctaY=size - pad - Math.round(size*0.12); drawPill(ctx,size/2,ctaY,Math.round(size*0.58),Math.round(size*0.075),'#111');
  ctx.fillStyle=brand; ctx.font=`700 ${Math.round(size*0.045)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`; ctx.fillText('Draai ook mee & steun KiKa üíõ', size/2, ctaY);
  ctx.fillStyle='#555'; ctx.font=`400 ${Math.round(size*0.028)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`; ctx.textAlign='center'; ctx.textBaseline='bottom';
  const shareURL=(window.location.origin + window.location.pathname); ctx.fillText(shareURL, size/2, size - pad + 10);
  drawConfettiScatter(ctx,size,30,0.65); return cvs;
}
function wrapText(ctx,text,maxWidth,lineHeight,maxLines=4){ const words=String(text).split(/\s+/); const lines=[]; let line=''; for(let i=0;i<words.length;i++){ const test=line?line+' '+words[i]:words[i]; if(ctx.measureText(test).width<=maxWidth){ line=test; }else{ if(line) lines.push(line); line=words[i]; if(lines.length===maxLines-1){ while(ctx.measureText(line+'‚Ä¶').width>maxWidth&&line.length>0){ line=line.slice(0,-1);} lines.push(line+'‚Ä¶'); return lines; } } } if(line) lines.push(line); return lines.slice(0,maxLines); }
function drawLines(ctx,lines,cx,y,lh){ lines.forEach((ln,i)=>ctx.fillText(ln,cx,y + i*lh)); }
function drawPill(ctx,cx,cy,w,h,color){ ctx.save(); ctx.fillStyle=color; const r=h/2; ctx.beginPath(); ctx.moveTo(cx-w/2+r,cy-h/2); ctx.arcTo(cx+w/2,cy-h/2,cx+w/2,cy+h/2,r); ctx.arcTo(cx+w/2,cy+h/2,cx-w/2,cy+h/2,r); ctx.arcTo(cx-w/2,cy+h/2,cx-w/2,cy-h/2,r); ctx.arcTo(cx-w/2,cy-h/2,cx+w/2,cy-h/2,r); ctx.closePath(); ctx.shadowColor='rgba(0,0,0,.08)'; ctx.shadowBlur=8; ctx.fill(); ctx.restore(); }
function drawRibbon(ctx,cx,cy,w,h,color){ ctx.save(); ctx.fillStyle='#fff'; ctx.shadowColor='rgba(0,0,0,.08)'; ctx.shadowBlur=8; ctx.beginPath(); ctx.moveTo(cx-w/2,cy-h/2); ctx.lineTo(cx+w/2,cy-h/2); ctx.lineTo(cx+w/2,cy+h/2); ctx.lineTo(cx-w/2,cy+h/2); ctx.closePath(); ctx.fill(); ctx.fillStyle=color; const tailW=Math.max(24,Math.round(w*0.06)); const tailH=Math.max(24,Math.round(h*0.9)); ctx.beginPath(); ctx.moveTo(cx-w/2,cy+h/2); ctx.lineTo(cx-w/2 - tailW, cy+h/2 + tailH/2); ctx.lineTo(cx-w/2 + tailW*0.3, cy+h/2); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.moveTo(cx+w/2,cy+h/2); ctx.lineTo(cx+w/2 + tailW, cy+h/2 + tailH/2); ctx.lineTo(cx+w/2 - tailW*0.3, cy+h/2); ctx.closePath(); ctx.fill(); ctx.restore(); }
function drawConfettiScatter(ctx,size,count=80,alpha=0.35){ const colors=["#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff","#06d6a0"]; ctx.save(); ctx.globalAlpha=alpha; for(let i=0;i<count;i++){ const x=Math.random()*size, y=Math.random()*size, w=6+Math.random()*16, h=8+Math.random()*18, r=Math.random()*Math.PI*2; ctx.save(); ctx.translate(x,y); ctx.rotate(r); ctx.fillStyle=colors[Math.floor(Math.random()*colors.length)]; ctx.shadowColor='rgba(0,0,0,.08)'; ctx.shadowBlur=4; ctx.fillRect(-w/2,-h/2,w,h); ctx.restore(); } ctx.restore(); }

/* ========= Selfie preview + animatie ========= */
const selfieBlock = document.getElementById('selfieBlock');
const selfieVideo = document.getElementById('selfieVideo');
const selfieCanvas = document.getElementById('selfieCanvas');
const selfieErr = document.getElementById('selfieErr');
const btnStartCam = document.getElementById('btnStartCam');
const btnShot = document.getElementById('btnShot');
const btnRetake = document.getElementById('btnRetake');
const btnDownload = document.getElementById('btnDownload');

let selfieStream = null;

/* Previewconfetti: state & helpers */
let previewRAF = null;           // requestAnimationFrame id
let previewConfetti = [];        // set stukjes voor preview (langzame wiebel)
let previewBursts = [];          // tijdelijke stukjes die vanzelf wegfaden
let previewPulseTimer = null;    // mini‚Äëpuls interval

function buildPreviewConfetti(w, h){
  const colors = ["#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff","#06d6a0"];
  const pieces = [];
  const count = 120;
  for (let i = 0; i < count; i++){
    // Startpositie vooral aan randen
    let x=Math.random()*w, y=Math.random()*h;
    const edge=Math.random();
    if (edge<0.25) y = Math.random()*h*0.18;
    else if (edge<0.50) y = h - Math.random()*h*0.18;
    else if (edge<0.75) x = Math.random()*w*0.18;
    else x = w - Math.random()*w*0.18;

    const vx = (Math.random()*30 - 15); // px/s
    const vy = 18 + Math.random()*14;   // px/s
    const vr = (Math.random()-0.5)*0.6; // rad/s

    pieces.push({
      x, y,
      w: 8 + Math.random()*18,
      h: 10 + Math.random()*22,
      r: Math.random()*Math.PI*2,
      vx, vy, vr,
      c: colors[Math.floor(Math.random()*colors.length)]
    });
  }
  return pieces;
}
function updateConfettiPieces(pieces, w, h, dtSec, reduced=false){
  const margin = 24;
  for (const p of pieces){
    if (!reduced){
      const wobble = Math.sin((performance.now()/600) + p.x*0.01) * 6;
      p.x += (p.vx + wobble) * dtSec * 0.25;
      p.y += p.vy * dtSec;
      p.r += p.vr * dtSec;
    }
    if (p.y > h + margin){ p.y = -margin; p.x = Math.random()*w; }
    if (p.x < -margin) p.x = w + margin;
    if (p.x >  w + margin) p.x = -margin;
  }
}
function drawConfettiPieces(ctx, pieces){
  ctx.save(); ctx.globalAlpha = 0.9;
  for (const p of pieces){
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r);
    ctx.fillStyle = p.c; ctx.shadowColor='rgba(0,0,0,.15)'; ctx.shadowBlur=6;
    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
  }
  ctx.restore();
}

/* Bursts (explosies) */
function triggerPreviewBurst(opts = {}){
  if (!selfieCanvas) return;
  const W = selfieCanvas.width, H = selfieCanvas.height;

  const {
    count = REDUCED_MOTION ? 20 : 48,
    speed = 240,
    g     = 220,
    lifeMin = 700,
    lifeMax = 1200,
    centerX = W/2,
    centerY = H*0.55,
    sizeMul = 1.0
  } = opts;

  const colors = ["#ffbe0b","#fb5607","#ff006e","#8338ec","#3a86ff","#06d6a0"];
  for (let i=0;i<count;i++){
    const a   = Math.random() * Math.PI * 2;
    const mag = 0.55 + Math.random() * 0.75;
    const vx  = Math.cos(a) * speed * mag;
    const vy  = Math.sin(a) * speed * mag;

    previewBursts.push({
      x:centerX, y:centerY,
      vx, vy,
      vr:(Math.random()-0.5)*4.0*Math.PI/180,
      w:(8+Math.random()*18)*sizeMul,
      h:(10+Math.random()*22)*sizeMul,
      r:Math.random()*Math.PI*2,
      g,
      c:colors[Math.floor(Math.random()*colors.length)],
      life:0,
      ttl: lifeMin + Math.random()*(lifeMax-lifeMin)
    });
  }
}
function updateAndDrawBursts(ctx, dtSec){
  const margin = 32;
  previewBursts = previewBursts.filter(p => {
    p.x += p.vx*dtSec; p.y += p.vy*dtSec; p.vy += p.g*dtSec; p.r += p.vr*dtSec; p.life += dtSec*1000;
    const alpha = Math.max(0, 1 - (p.life / p.ttl)); if (alpha <= 0) return false;
    ctx.save(); ctx.globalAlpha = 0.95 * alpha; ctx.translate(p.x,p.y); ctx.rotate(p.r);
    ctx.fillStyle = p.c; ctx.shadowColor='rgba(0,0,0,.18)'; ctx.shadowBlur=6; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
    const off = (p.x < -margin || p.x > ctx.canvas.width + margin || p.y > ctx.canvas.height + margin);
    return !off;
  });
}

/* Tekst overlay (preview + final) */
function drawSelfieText(ctx, w, h){
  const text = "Ik ben een topper, ik heb gedoneerd en steun KiKa!";
  const pad = Math.round(w*0.05), pillH=Math.round(w*0.12), pillW=Math.round(w*0.90), cx=w/2, cy=h - pad - pillH/2;
  ctx.save(); ctx.fillStyle='#111'; const r=pillH/2; ctx.beginPath();
  ctx.moveTo(cx - pillW/2 + r, cy - pillH/2);
  ctx.arcTo(cx + pillW/2, cy - pillH/2, cx + pillW/2, cy + pillH/2, r);
  ctx.arcTo(cx + pillW/2, cy + pillH/2, cx - pillW/2, cy + pillH/2, r);
  ctx.arcTo(cx - pillW/2, cy + pillH/2, cx - pillW/2, cy - pillH/2, r);
  ctx.arcTo(cx - pillW/2, cy - pillH/2, cx + pillW/2, cy - pillH/2, r);
  ctx.closePath(); ctx.shadowColor='rgba(0,0,0,.25)'; ctx.shadowBlur=10; ctx.fill();
  ctx.fillStyle='#ffb703'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`800 ${Math.round(w*0.045)}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
  const maxW=pillW*0.9; const words=text.split(/\s+/); const lines=[]; let line=''; for(let i=0;i<words.length;i++){ const t=line?line+' '+words[i]:words[i]; if(ctx.measureText(t).width<=maxW) line=t; else{ if(line) lines.push(line); line=words[i]; } } if(line) lines.push(line);
  const lh=Math.round(w*0.06), startY=cy - ((lines.length-1)*lh)/2; lines.slice(0,3).forEach((ln,i)=>ctx.fillText(ln,cx,startY + i*lh)); ctx.restore();
}

/* Preview loop met animatie + bursts + mini-puls */
function startSelfiePreviewLoop(){
  if (!selfieVideo || !selfieCanvas) return;
  const ctx = selfieCanvas.getContext('2d');
  const W = selfieCanvas.width, H = selfieCanvas.height;

  previewConfetti = buildPreviewConfetti(W, H);

  // Startexplosie
  triggerPreviewBurst({ count: REDUCED_MOTION ? 14 : 32, speed: 260, centerY: H*0.5 });

  // Mini‚Äëpuls elke ~2.2s
  if (previewPulseTimer) clearInterval(previewPulseTimer);
  previewPulseTimer = setInterval(() => {
    if (!previewRAF) return; // alleen tijdens live preview
    if (Math.random() < 0.6) {
      triggerPreviewBurst({ count: 14, speed: 220 });
    }
  }, 2200);

  let prevT = 0;
  function frame(t){
    if (!prevT) prevT = t;
    const dtSec = Math.min(0.05, (t - prevT) / 1000);
    prevT = t;

    // Videoframe (center‚Äëcrop ‚Üí vierkant)
    const vw = selfieVideo.videoWidth  || 1280;
    const vh = selfieVideo.videoHeight || 720;
    const side = Math.min(vw, vh);
    const sx = Math.floor((vw - side)/2);
    const sy = Math.floor((vh - side)/2);

    ctx.clearRect(0,0,W,H);
    ctx.drawImage(selfieVideo, sx, sy, side, side, 0, 0, W, H);

    // Langzame confetti
    updateConfettiPieces(previewConfetti, W, H, dtSec, REDUCED_MOTION);
    drawConfettiPieces(ctx, previewConfetti);

    // Tijdelijke bursts
    updateAndDrawBursts(ctx, dtSec);

    // Tekst in preview
    drawSelfieText(ctx, W, H);

    previewRAF = requestAnimationFrame(frame);
  }
  if (!previewRAF) previewRAF = requestAnimationFrame(frame);
}
function stopSelfiePreviewLoop(){
  if (previewRAF){ cancelAnimationFrame(previewRAF); previewRAF = null; }
  if (previewPulseTimer){ clearInterval(previewPulseTimer); previewPulseTimer = null; }
}

/* Flow helpers */
function showSelfieBlock(show){
  if (!selfieBlock) return;
  selfieBlock.hidden = !show;
  if (show){ selfieBlock.open = true; } // accordion open voor gebruik
  if (!show) stopSelfie();
}

/* Start camera ‚Äî robuust voor iOS */
async function startSelfie(){
  try{
    btnStartCam.disabled = true; selfieErr.textContent = '';
    selfieCanvas.style.display = 'block';
    selfieVideo.style.display  = 'block';
    btnShot.disabled = true;

    // iOS autoplay/inline
    selfieVideo.setAttribute('playsinline','');
    selfieVideo.setAttribute('muted','');
    selfieVideo.muted = true;

    if (!navigator.mediaDevices?.getUserMedia){
      throw new Error('Camera niet beschikbaar in deze browser.');
    }

    const constraints = {
      video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:1280} },
      audio:false
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    selfieStream = stream; selfieVideo.srcObject = stream;

    // Wacht tot we echte dimensies hebben
    await new Promise(res=>{
      if (selfieVideo.readyState >= 2) res();
      else selfieVideo.onloadedmetadata = () => res();
    });

    await selfieVideo.play();

    startSelfiePreviewLoop();              // live preview (confetti + tekst)
    btnShot.disabled = false;
  }catch(err){
    console.error('Camera start mislukte:', err);
    selfieErr.textContent = 'Camera starten mislukt. Geef toestemming of gebruik een apparaat met camera.';
    btnStartCam.disabled = false;
  }
}

/* Als iemand op shot drukt zonder camera, eerst camera starten */
async function ensureCameraThenShot(){
  if (!selfieStream){
    await startSelfie().catch(()=>{});
    if (!selfieStream) return; // abort bij fout
  }
  await takeSelfie();
}

async function takeSelfie(){
  // burst precies op het shot
  triggerPreviewBurst({ count: REDUCED_MOTION ? 20 : 40, speed: 300, centerY: selfieCanvas.height*0.5 });
  // Wacht √©√©n frame zodat de burst in het canvas staat en bevriest
  requestAnimationFrame(() => {
    stopSelfiePreviewLoop();
    selfieVideo.style.display = 'none';
    selfieCanvas.style.display = 'block';
    btnDownload.hidden = false;
    btnRetake.hidden   = false;
  });
}
function downloadSelfie(){
  try{
    const a=document.createElement('a');
    a.href=selfieCanvas.toDataURL('image/png');
    a.download=`kika-selfie-${Date.now()}.png`;
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ console.error('Selfie download:', e); selfieErr.textContent='Downloaden mislukt. Probeer opnieuw.'; }
}
function retakeSelfie(){
  if (selfieStream){
    selfieVideo.style.display = 'block';
    selfieCanvas.style.display = 'block';
    btnDownload.hidden = true;
    btnRetake.hidden   = true;
    startSelfiePreviewLoop();
  }else{
    startSelfie();
  }
}
function stopSelfie(){
  try{
    stopSelfiePreviewLoop();
    btnStartCam.disabled = false; btnShot.disabled = true; btnDownload.hidden = true; btnRetake.hidden = true;
    selfieVideo.style.display = 'block'; selfieCanvas.style.display = 'none';
    if (selfieStream){ selfieStream.getTracks().forEach(t=>t.stop()); selfieStream = null; }
  }catch{}
}

/* Tap op preview -> kleine burst */
document.addEventListener('click', (e) => {
  const stack = document.querySelector('.selfie__stack');
  if (stack && stack.contains(e.target) && previewRAF){
    triggerPreviewBurst({ count: 28, speed: 260 });
  }
});

/* ========= Share ========= */
const WHEEL_URL  = window.location.origin + window.location.pathname;
const DONATE_URL = 'https://24kika.nl/doneren/?deelnemer=steven-arbon';
let currentWin = { category:'', prize:'' };

function buildShareData(){
  const title='KiKa-wiel delen';
  const text=`üéâ ${currentWin.prize}\n\nDraai ook mee & steun KiKa:\n${DONATE_URL}`;
  const url=DONATE_URL; return { title, text, url };
}
function fillFallbackLinks(){
  const { text, url } = buildShareData();
  const wa=document.getElementById('shareWhatsApp');
  const tw=document.getElementById('shareX');
  const fb=document.getElementById('shareFB');
  const li=document.getElementById('shareLI');
  if (wa) wa.href = `https://wa.me/?text=${encodeURIComponent(text + '\n' + url)}`;
  if (tw) tw.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
  if (fb) fb.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`;
  if (li) li.href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
}
async function copyShareToClipboard(){
  const { text, url } = buildShareData(); const payload=`${text}\n${url}`; const feedback=document.getElementById('copyFeedback');
  try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(payload); } else { const ta=document.createElement('textarea'); ta.value=payload; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); } if (feedback) feedback.textContent='Gekopieerd ‚úîÔ∏è'; }catch(e){ if (feedback) feedback.textContent='Kopi√´ren mislukt. Probeer de knoppen hierboven.'; }
}
async function sharePrize(){
  const data=buildShareData(); const fb=document.getElementById('shareFallback');
  if (navigator.share){ try{ await navigator.share({ title:data.title, text:data.text, url:data.url }); if (fb) fb.classList.remove('show'); return; }catch{} }
  fillFallbackLinks(); if (fb) fb.classList.add('show');
}
document.getElementById('copyShare')?.addEventListener('click', copyShareToClipboard);

/* ========= Modal open/close ========= */
function isConfettiBonus(text){ if (typeof text!=='string') return false; const t=text.normalize('NFKD').toLowerCase().replace(/\s+/g,' ').trim(); return ( t.includes('confetti-bonus') || t.includes('confetti bonus') || /confetti.?bonus/.test(t) ); }
function openModal(prizeText, categoryText){
  const catEl=document.getElementById('modalCategory'); const prizeEl=document.getElementById('modalPrize'); const modal=document.getElementById('modal');
  currentWin = { category:(categoryText||'').trim(), prize:(prizeText||'').trim() };
  if (catEl) catEl.textContent = currentWin.category;
  if (prizeEl) prizeEl.textContent = currentWin.prize;
  modal.classList.add('open'); document.body.classList.add('lock-scroll');
  setTimeout(()=>document.getElementById('sheetHeader')?.focus(),0);
  const ariaResult=document.getElementById('ariaResult'); if (ariaResult) ariaResult.textContent = `Categorie: ${currentWin.category}. ${currentWin.prize}`;
  playGameShowJingle({ volume: 0.65 });
  const mega = isConfettiBonus(prizeText);
  showSelfieBlock(mega);
  if (mega) startMegaConfetti(); else launchStandardConfetti();
}
function closeModal(){
  document.getElementById('modal').classList.remove('open');
  document.body.classList.remove('lock-scroll');
  stopMegaConfetti();
  document.getElementById('shareFallback')?.classList.remove('show');
  selectedIndex = -1; drawWheel();
  showSelfieBlock(false);
}
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && document.getElementById('modal').classList.contains('open')) closeModal(); });

/* ====== Start ====== */
resizeWheelCanvas();

/* Selfie events */
btnStartCam?.addEventListener('click', startSelfie);
btnShot?.addEventListener('click', ensureCameraThenShot);
btnDownload?.addEventListener('click', downloadSelfie);
btnRetake?.addEventListener('click', retakeSelfie);
</script>
</body>
</html>

